<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A self-hosted media gallery for your private media collection."><meta name=author content="Ryan Jacobs"><link href=https://djryanj.github.io/media-viewer/development/architecture/ rel=canonical><link href=../../api/openapi/ rel=prev><link href=../testing/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.1"><title>Architecture - Media Viewer Documentation</title><link rel=stylesheet href=../../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=pink data-md-color-accent=pink> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#architecture class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Media Viewer Documentation" class="md-header__button md-logo" aria-label="Media Viewer Documentation" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 16V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2m-11-4 2.03 2.71L16 11l4 5H8M2 6v14a2 2 0 0 0 2 2h14v-2H4V6"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Media Viewer Documentation </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Architecture </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=pink data-md-color-accent=pink aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=pink data-md-color-accent=pink aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/djryanj/media-viewer title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> ghcr.io/djryanj/media-viewer </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../getting-started/installation/ class=md-tabs__link> Getting Started </a> </li> <li class=md-tabs__item> <a href=../../faq/ class=md-tabs__link> FAQ </a> </li> <li class=md-tabs__item> <a href=../../user-guide/overview/ class=md-tabs__link> User Guide </a> </li> <li class=md-tabs__item> <a href=../../features/pwa/ class=md-tabs__link> Features </a> </li> <li class=md-tabs__item> <a href=../../admin/overview/ class=md-tabs__link> Administration </a> </li> <li class=md-tabs__item> <a href=../../api/overview/ class=md-tabs__link> API Reference </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=./ class=md-tabs__link> Development </a> </li> <li class=md-tabs__item> <a href=../../troubleshooting/ class=md-tabs__link> Troubleshooting </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Media Viewer Documentation" class="md-nav__button md-logo" aria-label="Media Viewer Documentation" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22 16V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2m-11-4 2.03 2.71L16 11l4 5H8M2 6v14a2 2 0 0 0 2 2h14v-2H4V6"/></svg> </a> Media Viewer Documentation </label> <div class=md-nav__source> <a href=https://github.com/djryanj/media-viewer title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> ghcr.io/djryanj/media-viewer </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Getting Started </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Getting Started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../getting-started/installation/ class=md-nav__link> <span class=md-ellipsis> Installation </span> </a> </li> <li class=md-nav__item> <a href=../../getting-started/quick-start/ class=md-nav__link> <span class=md-ellipsis> Quick Start </span> </a> </li> <li class=md-nav__item> <a href=../../getting-started/configuration/ class=md-nav__link> <span class=md-ellipsis> Configuration </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../faq/ class=md-nav__link> <span class=md-ellipsis> FAQ </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> User Guide </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> User Guide </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../user-guide/overview/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/browsing/ class=md-nav__link> <span class=md-ellipsis> Browsing Media </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/search/ class=md-nav__link> <span class=md-ellipsis> Search </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/tagging/ class=md-nav__link> <span class=md-ellipsis> Tagging </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/favorites/ class=md-nav__link> <span class=md-ellipsis> Favorites </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/playlists/ class=md-nav__link> <span class=md-ellipsis> Playlists </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/webauthn/ class=md-nav__link> <span class=md-ellipsis> WebAuthn/Passkeys </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/keyboard-shortcuts/ class=md-nav__link> <span class=md-ellipsis> Keyboard Shortcuts </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Features </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Features </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../features/pwa/ class=md-nav__link> <span class=md-ellipsis> PWA Support </span> </a> </li> <li class=md-nav__item> <a href=../../features/tag-management/ class=md-nav__link> <span class=md-ellipsis> Tag Management </span> </a> </li> <li class=md-nav__item> <a href=../../features/selection-mode/ class=md-nav__link> <span class=md-ellipsis> Selection Mode </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> Administration </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Administration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../admin/overview/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../../admin/server-config/ class=md-nav__link> <span class=md-ellipsis> Server Configuration </span> </a> </li> <li class=md-nav__item> <a href=../../admin/environment-variables/ class=md-nav__link> <span class=md-ellipsis> Environment Variables </span> </a> </li> <li class=md-nav__item> <a href=../../admin/webauthn/ class=md-nav__link> <span class=md-ellipsis> WebAuthn Setup </span> </a> </li> <li class=md-nav__item> <a href=../../admin/thumbnails/ class=md-nav__link> <span class=md-ellipsis> Thumbnail Management </span> </a> </li> <li class=md-nav__item> <a href=../../admin/metrics/ class=md-nav__link> <span class=md-ellipsis> Metrics & Monitoring </span> </a> </li> <li class=md-nav__item> <a href=../../admin/security/ class=md-nav__link> <span class=md-ellipsis> Security </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> <span class=md-ellipsis> API Reference </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> API Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../api/overview/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../../api/authentication/ class=md-nav__link> <span class=md-ellipsis> Authentication </span> </a> </li> <li class=md-nav__item> <a href=../../api/webauthn/ class=md-nav__link> <span class=md-ellipsis> WebAuthn API </span> </a> </li> <li class=md-nav__item> <a href=../../api/files/ class=md-nav__link> <span class=md-ellipsis> Files & Media </span> </a> </li> <li class=md-nav__item> <a href=../../api/search/ class=md-nav__link> <span class=md-ellipsis> Search </span> </a> </li> <li class=md-nav__item> <a href=../../api/tags/ class=md-nav__link> <span class=md-ellipsis> Tags </span> </a> </li> <li class=md-nav__item> <a href=../../api/favorites/ class=md-nav__link> <span class=md-ellipsis> Favorites </span> </a> </li> <li class=md-nav__item> <a href=../../api/tags-favorites/ class=md-nav__link> <span class=md-ellipsis> Tags & Favorites </span> </a> </li> <li class=md-nav__item> <a href=../../api/system/ class=md-nav__link> <span class=md-ellipsis> System </span> </a> </li> <li class=md-nav__item> <a href=../../api/openapi/ class=md-nav__link> <span class=md-ellipsis> OpenAPI Spec </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_8 checked> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex> <span class=md-ellipsis> Development </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=true> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Development </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Architecture </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Architecture </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#overview class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#technology-stack class=md-nav__link> <span class=md-ellipsis> Technology Stack </span> </a> <nav class=md-nav aria-label="Technology Stack"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#backend class=md-nav__link> <span class=md-ellipsis> Backend </span> </a> </li> <li class=md-nav__item> <a href=#frontend class=md-nav__link> <span class=md-ellipsis> Frontend </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#backend-architecture class=md-nav__link> <span class=md-ellipsis> Backend Architecture </span> </a> <nav class=md-nav aria-label="Backend Architecture"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#project-structure class=md-nav__link> <span class=md-ellipsis> Project Structure </span> </a> </li> <li class=md-nav__item> <a href=#core-components class=md-nav__link> <span class=md-ellipsis> Core Components </span> </a> <nav class=md-nav aria-label="Core Components"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#http-server class=md-nav__link> <span class=md-ellipsis> HTTP Server </span> </a> </li> <li class=md-nav__item> <a href=#database-layer-internaldatabase class=md-nav__link> <span class=md-ellipsis> Database Layer (internal/database) </span> </a> </li> <li class=md-nav__item> <a href=#filesystem-layer-internalfilesystem class=md-nav__link> <span class=md-ellipsis> Filesystem Layer (internal/filesystem) </span> </a> </li> <li class=md-nav__item> <a href=#indexer-internalindexer class=md-nav__link> <span class=md-ellipsis> Indexer (internal/indexer) </span> </a> </li> <li class=md-nav__item> <a href=#thumbnail-generator-internalmedia class=md-nav__link> <span class=md-ellipsis> Thumbnail Generator (internal/media) </span> </a> </li> <li class=md-nav__item> <a href=#transcoder-internaltranscoder class=md-nav__link> <span class=md-ellipsis> Transcoder (internal/transcoder) </span> </a> </li> <li class=md-nav__item> <a href=#webauthn-handler-internalhandlerswebauthngo class=md-nav__link> <span class=md-ellipsis> WebAuthn Handler (internal/handlers/webauthn.go) </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#api-design class=md-nav__link> <span class=md-ellipsis> API Design </span> </a> </li> <li class=md-nav__item> <a href=#concurrency-model class=md-nav__link> <span class=md-ellipsis> Concurrency Model </span> </a> <nav class=md-nav aria-label="Concurrency Model"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#goroutines class=md-nav__link> <span class=md-ellipsis> Goroutines </span> </a> </li> <li class=md-nav__item> <a href=#worker-pools class=md-nav__link> <span class=md-ellipsis> Worker Pools </span> </a> </li> <li class=md-nav__item> <a href=#synchronization class=md-nav__link> <span class=md-ellipsis> Synchronization </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#memory-management class=md-nav__link> <span class=md-ellipsis> Memory Management </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#frontend-architecture class=md-nav__link> <span class=md-ellipsis> Frontend Architecture </span> </a> <nav class=md-nav aria-label="Frontend Architecture"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#module-structure class=md-nav__link> <span class=md-ellipsis> Module Structure </span> </a> </li> <li class=md-nav__item> <a href=#state-management class=md-nav__link> <span class=md-ellipsis> State Management </span> </a> </li> <li class=md-nav__item> <a href=#event-flow class=md-nav__link> <span class=md-ellipsis> Event Flow </span> </a> </li> <li class=md-nav__item> <a href=#history-management class=md-nav__link> <span class=md-ellipsis> History Management </span> </a> </li> <li class=md-nav__item> <a href=#webauthn-integration class=md-nav__link> <span class=md-ellipsis> WebAuthn Integration </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#database-schema class=md-nav__link> <span class=md-ellipsis> Database Schema </span> </a> <nav class=md-nav aria-label="Database Schema"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#core-tables class=md-nav__link> <span class=md-ellipsis> Core Tables </span> </a> <nav class=md-nav aria-label="Core Tables"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#files class=md-nav__link> <span class=md-ellipsis> files </span> </a> </li> <li class=md-nav__item> <a href=#tags class=md-nav__link> <span class=md-ellipsis> tags </span> </a> </li> <li class=md-nav__item> <a href=#file_tags class=md-nav__link> <span class=md-ellipsis> file_tags </span> </a> </li> <li class=md-nav__item> <a href=#favorites class=md-nav__link> <span class=md-ellipsis> favorites </span> </a> </li> <li class=md-nav__item> <a href=#users class=md-nav__link> <span class=md-ellipsis> users </span> </a> </li> <li class=md-nav__item> <a href=#sessions class=md-nav__link> <span class=md-ellipsis> sessions </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#webauthn-tables class=md-nav__link> <span class=md-ellipsis> WebAuthn Tables </span> </a> <nav class=md-nav aria-label="WebAuthn Tables"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#webauthn_credentials class=md-nav__link> <span class=md-ellipsis> webauthn_credentials </span> </a> </li> <li class=md-nav__item> <a href=#webauthn_sessions class=md-nav__link> <span class=md-ellipsis> webauthn_sessions </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#full-text-search class=md-nav__link> <span class=md-ellipsis> Full-Text Search </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#performance-considerations class=md-nav__link> <span class=md-ellipsis> Performance Considerations </span> </a> <nav class=md-nav aria-label="Performance Considerations"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#backend_1 class=md-nav__link> <span class=md-ellipsis> Backend </span> </a> </li> <li class=md-nav__item> <a href=#frontend_1 class=md-nav__link> <span class=md-ellipsis> Frontend </span> </a> </li> <li class=md-nav__item> <a href=#caching-strategy class=md-nav__link> <span class=md-ellipsis> Caching Strategy </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#security-model class=md-nav__link> <span class=md-ellipsis> Security Model </span> </a> <nav class=md-nav aria-label="Security Model"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#authentication class=md-nav__link> <span class=md-ellipsis> Authentication </span> </a> </li> <li class=md-nav__item> <a href=#authorization class=md-nav__link> <span class=md-ellipsis> Authorization </span> </a> </li> <li class=md-nav__item> <a href=#data-protection class=md-nav__link> <span class=md-ellipsis> Data Protection </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#monitoring-observability class=md-nav__link> <span class=md-ellipsis> Monitoring &amp; Observability </span> </a> <nav class=md-nav aria-label="Monitoring & Observability"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#prometheus-metrics class=md-nav__link> <span class=md-ellipsis> Prometheus Metrics </span> </a> </li> <li class=md-nav__item> <a href=#logging class=md-nav__link> <span class=md-ellipsis> Logging </span> </a> </li> <li class=md-nav__item> <a href=#health-checks class=md-nav__link> <span class=md-ellipsis> Health Checks </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#deployment-architecture class=md-nav__link> <span class=md-ellipsis> Deployment Architecture </span> </a> <nav class=md-nav aria-label="Deployment Architecture"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#container class=md-nav__link> <span class=md-ellipsis> Container </span> </a> </li> <li class=md-nav__item> <a href=#resource-limits class=md-nav__link> <span class=md-ellipsis> Resource Limits </span> </a> </li> <li class=md-nav__item> <a href=#scalability class=md-nav__link> <span class=md-ellipsis> Scalability </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#nfs-resilience-performance class=md-nav__link> <span class=md-ellipsis> NFS Resilience &amp; Performance </span> </a> <nav class=md-nav aria-label="NFS Resilience & Performance"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#common-nfs-issues class=md-nav__link> <span class=md-ellipsis> Common NFS Issues </span> </a> </li> <li class=md-nav__item> <a href=#automatic-retry-mechanism class=md-nav__link> <span class=md-ellipsis> Automatic Retry Mechanism </span> </a> </li> <li class=md-nav__item> <a href=#worker-tuning-for-nfs class=md-nav__link> <span class=md-ellipsis> Worker Tuning for NFS </span> </a> </li> <li class=md-nav__item> <a href=#integration-points class=md-nav__link> <span class=md-ellipsis> Integration Points </span> </a> </li> <li class=md-nav__item> <a href=#monitoring-nfs-health class=md-nav__link> <span class=md-ellipsis> Monitoring NFS Health </span> </a> </li> <li class=md-nav__item> <a href=#best-practices class=md-nav__link> <span class=md-ellipsis> Best Practices </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../testing/ class=md-nav__link> <span class=md-ellipsis> Testing </span> </a> </li> <li class=md-nav__item> <a href=../sample-media/ class=md-nav__link> <span class=md-ellipsis> Sample Media </span> </a> </li> <li class=md-nav__item> <a href=../contributing/ class=md-nav__link> <span class=md-ellipsis> Contributing </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../troubleshooting/ class=md-nav__link> <span class=md-ellipsis> Troubleshooting </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#overview class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#technology-stack class=md-nav__link> <span class=md-ellipsis> Technology Stack </span> </a> <nav class=md-nav aria-label="Technology Stack"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#backend class=md-nav__link> <span class=md-ellipsis> Backend </span> </a> </li> <li class=md-nav__item> <a href=#frontend class=md-nav__link> <span class=md-ellipsis> Frontend </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#backend-architecture class=md-nav__link> <span class=md-ellipsis> Backend Architecture </span> </a> <nav class=md-nav aria-label="Backend Architecture"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#project-structure class=md-nav__link> <span class=md-ellipsis> Project Structure </span> </a> </li> <li class=md-nav__item> <a href=#core-components class=md-nav__link> <span class=md-ellipsis> Core Components </span> </a> <nav class=md-nav aria-label="Core Components"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#http-server class=md-nav__link> <span class=md-ellipsis> HTTP Server </span> </a> </li> <li class=md-nav__item> <a href=#database-layer-internaldatabase class=md-nav__link> <span class=md-ellipsis> Database Layer (internal/database) </span> </a> </li> <li class=md-nav__item> <a href=#filesystem-layer-internalfilesystem class=md-nav__link> <span class=md-ellipsis> Filesystem Layer (internal/filesystem) </span> </a> </li> <li class=md-nav__item> <a href=#indexer-internalindexer class=md-nav__link> <span class=md-ellipsis> Indexer (internal/indexer) </span> </a> </li> <li class=md-nav__item> <a href=#thumbnail-generator-internalmedia class=md-nav__link> <span class=md-ellipsis> Thumbnail Generator (internal/media) </span> </a> </li> <li class=md-nav__item> <a href=#transcoder-internaltranscoder class=md-nav__link> <span class=md-ellipsis> Transcoder (internal/transcoder) </span> </a> </li> <li class=md-nav__item> <a href=#webauthn-handler-internalhandlerswebauthngo class=md-nav__link> <span class=md-ellipsis> WebAuthn Handler (internal/handlers/webauthn.go) </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#api-design class=md-nav__link> <span class=md-ellipsis> API Design </span> </a> </li> <li class=md-nav__item> <a href=#concurrency-model class=md-nav__link> <span class=md-ellipsis> Concurrency Model </span> </a> <nav class=md-nav aria-label="Concurrency Model"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#goroutines class=md-nav__link> <span class=md-ellipsis> Goroutines </span> </a> </li> <li class=md-nav__item> <a href=#worker-pools class=md-nav__link> <span class=md-ellipsis> Worker Pools </span> </a> </li> <li class=md-nav__item> <a href=#synchronization class=md-nav__link> <span class=md-ellipsis> Synchronization </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#memory-management class=md-nav__link> <span class=md-ellipsis> Memory Management </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#frontend-architecture class=md-nav__link> <span class=md-ellipsis> Frontend Architecture </span> </a> <nav class=md-nav aria-label="Frontend Architecture"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#module-structure class=md-nav__link> <span class=md-ellipsis> Module Structure </span> </a> </li> <li class=md-nav__item> <a href=#state-management class=md-nav__link> <span class=md-ellipsis> State Management </span> </a> </li> <li class=md-nav__item> <a href=#event-flow class=md-nav__link> <span class=md-ellipsis> Event Flow </span> </a> </li> <li class=md-nav__item> <a href=#history-management class=md-nav__link> <span class=md-ellipsis> History Management </span> </a> </li> <li class=md-nav__item> <a href=#webauthn-integration class=md-nav__link> <span class=md-ellipsis> WebAuthn Integration </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#database-schema class=md-nav__link> <span class=md-ellipsis> Database Schema </span> </a> <nav class=md-nav aria-label="Database Schema"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#core-tables class=md-nav__link> <span class=md-ellipsis> Core Tables </span> </a> <nav class=md-nav aria-label="Core Tables"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#files class=md-nav__link> <span class=md-ellipsis> files </span> </a> </li> <li class=md-nav__item> <a href=#tags class=md-nav__link> <span class=md-ellipsis> tags </span> </a> </li> <li class=md-nav__item> <a href=#file_tags class=md-nav__link> <span class=md-ellipsis> file_tags </span> </a> </li> <li class=md-nav__item> <a href=#favorites class=md-nav__link> <span class=md-ellipsis> favorites </span> </a> </li> <li class=md-nav__item> <a href=#users class=md-nav__link> <span class=md-ellipsis> users </span> </a> </li> <li class=md-nav__item> <a href=#sessions class=md-nav__link> <span class=md-ellipsis> sessions </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#webauthn-tables class=md-nav__link> <span class=md-ellipsis> WebAuthn Tables </span> </a> <nav class=md-nav aria-label="WebAuthn Tables"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#webauthn_credentials class=md-nav__link> <span class=md-ellipsis> webauthn_credentials </span> </a> </li> <li class=md-nav__item> <a href=#webauthn_sessions class=md-nav__link> <span class=md-ellipsis> webauthn_sessions </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#full-text-search class=md-nav__link> <span class=md-ellipsis> Full-Text Search </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#performance-considerations class=md-nav__link> <span class=md-ellipsis> Performance Considerations </span> </a> <nav class=md-nav aria-label="Performance Considerations"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#backend_1 class=md-nav__link> <span class=md-ellipsis> Backend </span> </a> </li> <li class=md-nav__item> <a href=#frontend_1 class=md-nav__link> <span class=md-ellipsis> Frontend </span> </a> </li> <li class=md-nav__item> <a href=#caching-strategy class=md-nav__link> <span class=md-ellipsis> Caching Strategy </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#security-model class=md-nav__link> <span class=md-ellipsis> Security Model </span> </a> <nav class=md-nav aria-label="Security Model"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#authentication class=md-nav__link> <span class=md-ellipsis> Authentication </span> </a> </li> <li class=md-nav__item> <a href=#authorization class=md-nav__link> <span class=md-ellipsis> Authorization </span> </a> </li> <li class=md-nav__item> <a href=#data-protection class=md-nav__link> <span class=md-ellipsis> Data Protection </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#monitoring-observability class=md-nav__link> <span class=md-ellipsis> Monitoring &amp; Observability </span> </a> <nav class=md-nav aria-label="Monitoring & Observability"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#prometheus-metrics class=md-nav__link> <span class=md-ellipsis> Prometheus Metrics </span> </a> </li> <li class=md-nav__item> <a href=#logging class=md-nav__link> <span class=md-ellipsis> Logging </span> </a> </li> <li class=md-nav__item> <a href=#health-checks class=md-nav__link> <span class=md-ellipsis> Health Checks </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#deployment-architecture class=md-nav__link> <span class=md-ellipsis> Deployment Architecture </span> </a> <nav class=md-nav aria-label="Deployment Architecture"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#container class=md-nav__link> <span class=md-ellipsis> Container </span> </a> </li> <li class=md-nav__item> <a href=#resource-limits class=md-nav__link> <span class=md-ellipsis> Resource Limits </span> </a> </li> <li class=md-nav__item> <a href=#scalability class=md-nav__link> <span class=md-ellipsis> Scalability </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#nfs-resilience-performance class=md-nav__link> <span class=md-ellipsis> NFS Resilience &amp; Performance </span> </a> <nav class=md-nav aria-label="NFS Resilience & Performance"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#common-nfs-issues class=md-nav__link> <span class=md-ellipsis> Common NFS Issues </span> </a> </li> <li class=md-nav__item> <a href=#automatic-retry-mechanism class=md-nav__link> <span class=md-ellipsis> Automatic Retry Mechanism </span> </a> </li> <li class=md-nav__item> <a href=#worker-tuning-for-nfs class=md-nav__link> <span class=md-ellipsis> Worker Tuning for NFS </span> </a> </li> <li class=md-nav__item> <a href=#integration-points class=md-nav__link> <span class=md-ellipsis> Integration Points </span> </a> </li> <li class=md-nav__item> <a href=#monitoring-nfs-health class=md-nav__link> <span class=md-ellipsis> Monitoring NFS Health </span> </a> </li> <li class=md-nav__item> <a href=#best-practices class=md-nav__link> <span class=md-ellipsis> Best Practices </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=architecture>Architecture</h1> <p>This document describes the technical architecture of Media Viewer.</p> <h2 id=overview>Overview</h2> <p>Media Viewer is a client-server application with:</p> <ul> <li><strong>Frontend</strong>: Single-page application (SPA) using vanilla JavaScript, HTML, and CSS</li> <li><strong>Backend</strong>: Go HTTP server with Gorilla Mux router</li> <li><strong>Database</strong>: SQLite with FTS5 for full-text search</li> <li><strong>Storage</strong>: File system for media files, thumbnails, and transcoded videos</li> <li><strong>Media Processing</strong>: FFmpeg for video transcoding and thumbnail generation</li> </ul> <h2 id=technology-stack>Technology Stack</h2> <h3 id=backend>Backend</h3> <ul> <li><strong>Language</strong>: Go 1.21+</li> <li><strong>HTTP Router</strong>: Gorilla Mux</li> <li><strong>Database</strong>: SQLite with CGO (FTS5 extension)</li> <li><strong>Authentication</strong>: WebAuthn (go-webauthn/webauthn) + bcrypt password hashing</li> <li><strong>Media Processing</strong>: FFmpeg (via exec)</li> <li><strong>Metrics</strong>: Prometheus client library</li> </ul> <h3 id=frontend>Frontend</h3> <ul> <li><strong>JavaScript</strong>: Vanilla ES6+ (no frameworks)</li> <li><strong>CSS</strong>: Custom CSS with CSS Grid and Flexbox</li> <li><strong>Icons</strong>: Lucide Icons (SVG)</li> <li><strong>PWA</strong>: Service Worker, Web App Manifest</li> <li><strong>APIs</strong>: WebAuthn, Wake Lock, Intersection Observer</li> </ul> <h2 id=backend-architecture>Backend Architecture</h2> <h3 id=project-structure>Project Structure</h3> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>media-viewer/
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>├── cmd/
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>│   └── resetpw/          # Password reset utility
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>├── internal/
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>│   ├── database/         # SQLite operations
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>│   ├── filesystem/       # Resilient filesystem operations
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>│   ├── handlers/         # HTTP request handlers
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>│   ├── indexer/          # Media library indexer
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>│   ├── logging/          # Structured logging
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>│   ├── media/            # Thumbnail generation
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>│   ├── memory/           # Memory monitoring
<a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a>│   ├── metrics/          # Prometheus metrics
<a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a>│   ├── middleware/       # HTTP middleware
<a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>│   ├── mediatypes/       # File type detection
<a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a>│   ├── startup/          # Application initialization
<a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a>│   ├── streaming/        # Video streaming utilities
<a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a>│   ├── transcoder/       # Video transcoding
<a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a>│   └── workers/          # Worker pool utilities
<a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a>├── static/               # Frontend assets
<a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a>│   ├── css/
<a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a>│   ├── js/
<a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a>│   ├── icons/
<a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a>│   └── *.html
<a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a>└── main.go              # Application entry point
</code></pre></div> <h3 id=core-components>Core Components</h3> <h4 id=http-server>HTTP Server</h4> <ul> <li><strong>Router</strong>: Gorilla Mux for flexible routing</li> <li><strong>Middleware</strong>: Logging, compression, metrics, authentication</li> <li><strong>Timeouts</strong>: Configurable read/write timeouts</li> <li><strong>Graceful Shutdown</strong>: Cleanup on SIGINT/SIGTERM</li> </ul> <h4 id=database-layer-internaldatabase>Database Layer (<code>internal/database</code>)</h4> <ul> <li><strong>Connection</strong>: Single SQLite connection with mutex-based locking</li> <li><strong>Migrations</strong>: Automatic schema initialization</li> <li><strong>Indexes</strong>: Optimized for file path and tag queries</li> <li><strong>FTS5</strong>: Full-text search on file names</li> <li><strong>Transactions</strong>: Proper transaction handling for data integrity</li> </ul> <h4 id=filesystem-layer-internalfilesystem>Filesystem Layer (<code>internal/filesystem</code>)</h4> <p>Provides resilient filesystem operations with automatic retry logic for NFS stability:</p> <ul> <li><strong>Retry Logic</strong>: Automatic retry with exponential backoff for ESTALE errors</li> <li><strong>StatWithRetry</strong>: Wraps <code>os.Stat</code> with up to 3 retry attempts</li> <li><strong>OpenWithRetry</strong>: Wraps <code>os.Open</code> with up to 3 retry attempts</li> <li><strong>Exponential Backoff</strong>: 50ms → 100ms → 200ms between retries</li> <li><strong>Minimal Overhead</strong>: ~100ns additional latency on successful operations</li> <li><strong>Smart Detection</strong>: Only retries NFS stale file handle errors (ESTALE errno 116)</li> <li><strong>Logging</strong>: Successful retries logged for monitoring and debugging</li> </ul> <p>This layer prevents crashes and improves stability when serving media from NFS mounts, where stale file handles can occur due to network issues or server-side changes.</p> <h4 id=indexer-internalindexer>Indexer (<code>internal/indexer</code>)</h4> <ul> <li><strong>Parallel Walker</strong>: Multi-threaded directory scanning</li> <li><strong>Change Detection</strong>: Polling-based file system monitoring</li> <li><strong>Incremental Updates</strong>: Only processes new/modified/deleted files</li> <li><strong>Notifications</strong>: Triggers thumbnail generation after index completion</li> </ul> <h4 id=thumbnail-generator-internalmedia>Thumbnail Generator (<code>internal/media</code>)</h4> <ul> <li><strong>On-Demand</strong>: Generates thumbnails when requested</li> <li><strong>Background Worker</strong>: Batch generation for new files</li> <li><strong>FFmpeg Integration</strong>: Extracts video frames</li> <li><strong>Image Processing</strong>: Resizes and optimizes images</li> <li><strong>Per-File Locking</strong>: Prevents duplicate generation</li> </ul> <h4 id=transcoder-internaltranscoder>Transcoder (<code>internal/transcoder</code>)</h4> <ul> <li><strong>Streaming</strong>: Chunks video on-the-fly</li> <li><strong>Caching</strong>: Stores transcoded files for reuse</li> <li><strong>Format Detection</strong>: Determines if transcoding is needed</li> <li><strong>FFmpeg Pipeline</strong>: H.264 encoding for browser compatibility</li> </ul> <h4 id=webauthn-handler-internalhandlerswebauthngo>WebAuthn Handler (<code>internal/handlers/webauthn.go</code>)</h4> <ul> <li><strong>Registration</strong>: Passkey enrollment with challenge-response</li> <li><strong>Authentication</strong>: Passwordless login with signature verification</li> <li><strong>Session Management</strong>: Temporary challenge storage (5-minute TTL)</li> <li><strong>Credential Storage</strong>: Encrypted credential storage in database</li> </ul> <h3 id=api-design>API Design</h3> <p>RESTful API with JSON responses:</p> <ul> <li><code>GET</code> - Resource retrieval</li> <li><code>POST</code> - Resource creation, actions</li> <li><code>PUT</code> - Resource updates</li> <li><code>DELETE</code> - Resource deletion</li> </ul> <p>Authentication via HTTP-only session cookies (SHA-256 hashed tokens).</p> <h3 id=concurrency-model>Concurrency Model</h3> <h4 id=goroutines>Goroutines</h4> <ul> <li><strong>HTTP Server</strong>: One goroutine per request</li> <li><strong>Indexer</strong>: Background goroutine with ticker</li> <li><strong>Thumbnail Generator</strong>: Worker pool with configurable size</li> <li><strong>Session Cleanup</strong>: Periodic cleanup goroutine</li> <li><strong>Metrics Collector</strong>: Background stats collection</li> </ul> <h4 id=worker-pools>Worker Pools</h4> <p>Sized based on available CPU cores (respects container limits):</p> <ul> <li><strong>CPU-bound tasks</strong>: <code>runtime.GOMAXPROCS(0)</code> workers</li> <li><strong>I/O-bound tasks</strong>: <code>2 * GOMAXPROCS(0)</code> workers</li> <li><strong>Mixed workload</strong>: <code>1.5 * GOMAXPROCS(0)</code> workers</li> </ul> <h4 id=synchronization>Synchronization</h4> <ul> <li><strong>Database</strong>: Read-write mutex (<code>sync.RWMutex</code>)</li> <li><strong>Thumbnail Generation</strong>: Per-file locks (map of mutexes)</li> <li><strong>Context Propagation</strong>: Cancellation and timeouts</li> </ul> <h3 id=memory-management>Memory Management</h3> <ul> <li><strong>GOMEMLIMIT</strong>: Configurable via environment or Kubernetes Downward API</li> <li><strong>Memory Ratio</strong>: Reserves memory for FFmpeg and OS buffers</li> <li><strong>GC Tuning</strong>: Aggressive collection when approaching limit</li> <li><strong>Monitoring</strong>: Prometheus metrics for heap, sys, and GC stats</li> </ul> <h2 id=frontend-architecture>Frontend Architecture</h2> <h3 id=module-structure>Module Structure</h3> <p>The frontend is organized into independent modules:</p> <table> <thead> <tr> <th>Module</th> <th>File</th> <th>Purpose</th> </tr> </thead> <tbody> <tr> <td>MediaApp</td> <td><code>app.js</code></td> <td>Main application controller</td> </tr> <tr> <td>Gallery</td> <td><code>gallery.js</code></td> <td>Gallery rendering and interactions</td> </tr> <tr> <td>Lightbox</td> <td><code>lightbox.js</code></td> <td>Full-screen media viewer</td> </tr> <tr> <td>Search</td> <td><code>search.js</code></td> <td>Search functionality</td> </tr> <tr> <td>Tags</td> <td><code>tags.js</code></td> <td>Tag management</td> </tr> <tr> <td>Favorites</td> <td><code>favorites.js</code></td> <td>Favorites management</td> </tr> <tr> <td>ItemSelection</td> <td><code>selection.js</code></td> <td>Multi-select mode</td> </tr> <tr> <td>TagClipboard</td> <td><code>tag-clipboard.js</code></td> <td>Tag copy/paste</td> </tr> <tr> <td>Player</td> <td><code>playlist.js</code></td> <td>Playlist player</td> </tr> <tr> <td>HistoryManager</td> <td><code>history.js</code></td> <td>Browser history management</td> </tr> <tr> <td>InfiniteScroll</td> <td><code>infinite-scroll.js</code></td> <td>Gallery pagination</td> </tr> <tr> <td>InfiniteScrollSearch</td> <td><code>infinite-scroll-search.js</code></td> <td>Search pagination</td> </tr> <tr> <td>WebAuthnManager</td> <td><code>webauthn.js</code></td> <td>Passkey authentication</td> </tr> <tr> <td>SettingsManager</td> <td><code>settings.js</code></td> <td>Settings modal and management</td> </tr> <tr> <td>SessionManager</td> <td><code>session.js</code></td> <td>Session keepalive</td> </tr> <tr> <td>WakeLockManager</td> <td><code>wake-lock.js</code></td> <td>Screen wake lock</td> </tr> <tr> <td>TagTooltip</td> <td><code>tag-tooltip.js</code></td> <td>Tag overflow tooltip</td> </tr> <tr> <td>PreferencesManager</td> <td><code>preferences.js</code></td> <td>User preferences storage</td> </tr> </tbody> </table> <h3 id=state-management>State Management</h3> <p>Application state is managed in <code>MediaApp.state</code>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=p>{</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=w>  </span><span class=nx>currentPath</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=p>,</span><span class=w>      </span><span class=c1>// Current directory path</span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=w>  </span><span class=nx>listing</span><span class=o>:</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w>        </span><span class=c1>// Current directory listing</span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=w>  </span><span class=nx>mediaFiles</span><span class=o>:</span><span class=w> </span><span class=p>[],</span><span class=w>       </span><span class=c1>// Files for lightbox navigation</span>
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=w>  </span><span class=nx>currentSort</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>field</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;name&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>order</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;asc&#39;</span><span class=w> </span><span class=p>},</span>
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=w>  </span><span class=nx>currentFilter</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;all&#39;</span><span class=p>,</span>
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=w>  </span><span class=nx>currentPage</span><span class=o>:</span><span class=w> </span><span class=mf>1</span><span class=p>,</span>
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=w>  </span><span class=nx>hasMore</span><span class=o>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span>
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=w>  </span><span class=nx>isSearchMode</span><span class=o>:</span><span class=w> </span><span class=kc>false</span><span class=p>,</span>
<a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=w>  </span><span class=nx>searchQuery</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;&#39;</span>
<a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=p>}</span>
</code></pre></div> <h3 id=event-flow>Event Flow</h3> <ol> <li>User interaction triggers event handler</li> <li>Handler updates state and/or calls API</li> <li>API response updates state via <code>setState()</code></li> <li>UI components re-render based on new state</li> </ol> <h3 id=history-management>History Management</h3> <p>Browser history is managed for:</p> <ul> <li>Directory navigation (pushState)</li> <li>Lightbox overlay (replaceState)</li> <li>Search results (pushState)</li> </ul> <p>The <code>HistoryManager</code> module handles back/forward navigation and state restoration.</p> <h3 id=webauthn-integration>WebAuthn Integration</h3> <ul> <li><strong>Registration</strong>: Custom naming modal before browser prompt</li> <li><strong>Authentication</strong>: Conditional UI (autofill) + manual button + auto-prompt</li> <li><strong>Credential Management</strong>: List, add, delete passkeys</li> <li><strong>Fallback</strong>: Always maintains password auth option</li> </ul> <h2 id=database-schema>Database Schema</h2> <h3 id=core-tables>Core Tables</h3> <h4 id=files><code>files</code></h4> <p>Indexed media files:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>files</span><span class=w> </span><span class=p>(</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=w>    </span><span class=n>path</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=w>    </span><span class=n>name</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=w>    </span><span class=k>type</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=w>    </span><span class=k>size</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=w>    </span><span class=n>modified_at</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span>
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=p>);</span>
</code></pre></div> <h4 id=tags><code>tags</code></h4> <p>Tag definitions:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>tags</span><span class=w> </span><span class=p>(</span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=n>AUTOINCREMENT</span><span class=p>,</span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=w>    </span><span class=n>name</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>UNIQUE</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=p>);</span>
</code></pre></div> <h4 id=file_tags><code>file_tags</code></h4> <p>File-tag associations:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>file_tags</span><span class=w> </span><span class=p>(</span>
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=w>    </span><span class=n>file_path</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=w>    </span><span class=n>tag_id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=w>    </span><span class=k>FOREIGN</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span><span class=w> </span><span class=k>REFERENCES</span><span class=w> </span><span class=n>files</span><span class=p>(</span><span class=n>path</span><span class=p>)</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>DELETE</span><span class=w> </span><span class=k>CASCADE</span><span class=p>,</span>
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=w>    </span><span class=k>FOREIGN</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=n>tag_id</span><span class=p>)</span><span class=w> </span><span class=k>REFERENCES</span><span class=w> </span><span class=n>tags</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>DELETE</span><span class=w> </span><span class=k>CASCADE</span><span class=p>,</span>
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=w>    </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span><span class=w> </span><span class=n>tag_id</span><span class=p>)</span>
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=p>);</span>
</code></pre></div> <h4 id=favorites><code>favorites</code></h4> <p>Favorited items:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>favorites</span><span class=w> </span><span class=p>(</span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=w>    </span><span class=n>path</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=w>    </span><span class=n>name</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=w>    </span><span class=k>type</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=w>    </span><span class=n>added_at</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=p>(</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%s&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;now&#39;</span><span class=p>))</span>
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=p>);</span>
</code></pre></div> <h4 id=users><code>users</code></h4> <p>Single user account:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=p>(</span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=n>AUTOINCREMENT</span><span class=p>,</span>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=w>    </span><span class=n>password_hash</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=w>    </span><span class=n>created_at</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=w>    </span><span class=n>updated_at</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span>
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=p>);</span>
</code></pre></div> <h4 id=sessions><code>sessions</code></h4> <p>Active user sessions:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>sessions</span><span class=w> </span><span class=p>(</span>
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=n>AUTOINCREMENT</span><span class=p>,</span>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=w>    </span><span class=n>user_id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=w>    </span><span class=n>token_hash</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>UNIQUE</span><span class=p>,</span>
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=w>    </span><span class=n>expires_at</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=w>    </span><span class=n>created_at</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=w>    </span><span class=n>last_activity</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=w>    </span><span class=k>FOREIGN</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span><span class=w> </span><span class=k>REFERENCES</span><span class=w> </span><span class=n>users</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>DELETE</span><span class=w> </span><span class=k>CASCADE</span>
<a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=p>);</span>
</code></pre></div> <h3 id=webauthn-tables>WebAuthn Tables</h3> <h4 id=webauthn_credentials><code>webauthn_credentials</code></h4> <p>Registered passkeys:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>webauthn_credentials</span><span class=w> </span><span class=p>(</span>
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=n>AUTOINCREMENT</span><span class=p>,</span>
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=w>    </span><span class=n>user_id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=w>    </span><span class=n>credential_id</span><span class=w> </span><span class=nb>BLOB</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>UNIQUE</span><span class=p>,</span>
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=w>    </span><span class=n>public_key</span><span class=w> </span><span class=nb>BLOB</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=w>    </span><span class=n>attestation_type</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=w>    </span><span class=n>aaguid</span><span class=w> </span><span class=nb>BLOB</span><span class=p>,</span>
<a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=w>    </span><span class=n>sign_count</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=w>    </span><span class=n>name</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=s1>&#39;Passkey&#39;</span><span class=p>,</span>
<a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a><span class=w>    </span><span class=n>transports</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span>
<a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=w>    </span><span class=n>created_at</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a><span class=w>    </span><span class=n>last_used_at</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=w>    </span><span class=k>FOREIGN</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span><span class=w> </span><span class=k>REFERENCES</span><span class=w> </span><span class=n>users</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>DELETE</span><span class=w> </span><span class=k>CASCADE</span>
<a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a><span class=p>);</span>
</code></pre></div> <h4 id=webauthn_sessions><code>webauthn_sessions</code></h4> <p>WebAuthn challenge data:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>webauthn_sessions</span><span class=w> </span><span class=p>(</span>
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=n>AUTOINCREMENT</span><span class=p>,</span>
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=w>    </span><span class=n>session_id</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>UNIQUE</span><span class=p>,</span>
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=w>    </span><span class=n>session_data</span><span class=w> </span><span class=nb>BLOB</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=w>    </span><span class=n>expires_at</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span>
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=w>    </span><span class=n>created_at</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span>
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=p>);</span>
</code></pre></div> <h3 id=full-text-search>Full-Text Search</h3> <p>FTS5 virtual table for file search:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=k>CREATE</span><span class=w> </span><span class=n>VIRTUAL</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>files_fts</span><span class=w> </span><span class=k>USING</span><span class=w> </span><span class=n>fts5</span><span class=p>(</span>
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=w>    </span><span class=n>path</span><span class=p>,</span>
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=w>    </span><span class=n>name</span><span class=p>,</span>
<a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=w>    </span><span class=n>content</span><span class=o>=</span><span class=n>files</span><span class=p>,</span>
<a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=w>    </span><span class=n>content_rowid</span><span class=o>=</span><span class=n>rowid</span>
<a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=p>);</span>
</code></pre></div> <h2 id=performance-considerations>Performance Considerations</h2> <h3 id=backend_1>Backend</h3> <ul> <li><strong>Parallel Indexing</strong>: Multi-threaded directory walker (2-4x faster)</li> <li><strong>Parallel Thumbnails</strong>: Worker pool for thumbnail generation</li> <li><strong>Per-File Locks</strong>: Prevents duplicate thumbnail generation</li> <li><strong>SQLite Indexes</strong>: Optimized queries on path, tags, favorites</li> <li><strong>Streaming</strong>: Chunked video delivery with timeout protection</li> <li><strong>Context Cancellation</strong>: Stops work when clients disconnect</li> </ul> <h3 id=frontend_1>Frontend</h3> <ul> <li><strong>Infinite Scroll</strong>: Reduces initial load time</li> <li><strong>Intersection Observer</strong>: Efficient scroll detection</li> <li><strong>Lazy Loading</strong>: Thumbnails loaded as needed</li> <li><strong>Batched Updates</strong>: Single DOM paint for selection changes</li> <li><strong>Service Worker</strong>: Caches static assets</li> <li><strong>Debouncing</strong>: Search input and scroll events</li> </ul> <h3 id=caching-strategy>Caching Strategy</h3> <table> <thead> <tr> <th>Resource</th> <th>Cache Location</th> <th>Duration</th> <th>Strategy</th> </tr> </thead> <tbody> <tr> <td>Static assets</td> <td>Service Worker</td> <td>7 days</td> <td>Cache first</td> </tr> <tr> <td>Thumbnails</td> <td>Disk + Browser</td> <td>1 year</td> <td>Cache with revalid</td> </tr> <tr> <td>Transcoded video</td> <td>Disk</td> <td>Varies</td> <td>On-demand</td> </tr> <tr> <td>API responses</td> <td>None</td> <td>N/A</td> <td>Always fresh</td> </tr> </tbody> </table> <h2 id=security-model>Security Model</h2> <h3 id=authentication>Authentication</h3> <ul> <li><strong>Password</strong>: bcrypt hashing (cost 10)</li> <li><strong>Sessions</strong>: SHA-256 hashed tokens, HTTP-only cookies</li> <li><strong>WebAuthn</strong>: FIDO2 with user verification required</li> <li><strong>Expiration</strong>: Sliding window (default 24h)</li> </ul> <h3 id=authorization>Authorization</h3> <p>Single-user model:</p> <ul> <li>All authenticated users have full access</li> <li>No role-based access control</li> <li>Path traversal prevention in file handlers</li> </ul> <h3 id=data-protection>Data Protection</h3> <ul> <li><strong>Passwords</strong>: Never logged or transmitted in plain text</li> <li><strong>Sessions</strong>: Secure, HTTP-only, SameSite=Strict cookies</li> <li><strong>WebAuthn</strong>: Private keys never leave user's device</li> <li><strong>HTTPS</strong>: Required for WebAuthn in production</li> </ul> <h2 id=monitoring-observability>Monitoring &amp; Observability</h2> <h3 id=prometheus-metrics>Prometheus Metrics</h3> <p>Exposed on separate port (default 9090):</p> <ul> <li><strong>HTTP</strong>: Request count, duration, status codes</li> <li><strong>Database</strong>: Query count, duration, errors</li> <li><strong>Memory</strong>: Heap, sys, GC stats</li> <li><strong>Thumbnails</strong>: Generation count, duration, cache hits</li> <li><strong>Indexer</strong>: Files indexed, scan duration</li> </ul> <h3 id=logging>Logging</h3> <p>Structured logging with levels:</p> <ul> <li><code>debug</code> - Detailed operation logs</li> <li><code>info</code> - Normal operational messages</li> <li><code>warn</code> - Concerning but non-critical events</li> <li><code>error</code> - Error conditions requiring attention</li> </ul> <h3 id=health-checks>Health Checks</h3> <p>Multiple endpoints:</p> <ul> <li><code>/health</code> - Basic health check</li> <li><code>/livez</code> - Liveness probe (is process running?)</li> <li><code>/readyz</code> - Readiness probe (can it serve traffic?)</li> </ul> <h2 id=deployment-architecture>Deployment Architecture</h2> <h3 id=container>Container</h3> <ul> <li><strong>Base Image</strong>: Alpine Linux (small size)</li> <li><strong>Runtime</strong>: Go binary + FFmpeg</li> <li><strong>Volumes</strong>: Media (read-only), cache, database</li> <li><strong>Ports</strong>: 8080 (HTTP), 9090 (metrics)</li> </ul> <h3 id=resource-limits>Resource Limits</h3> <p>Recommended for typical deployment:</p> <ul> <li><strong>CPU</strong>: 1-2 cores</li> <li><strong>Memory</strong>: 512MB-2GB (depends on library size)</li> <li><strong>Storage</strong>: Depends on thumbnail cache size</li> </ul> <h3 id=scalability>Scalability</h3> <p>Current limitations (single-user design):</p> <ul> <li>Single SQLite database (not distributed)</li> <li>Single server instance (no horizontal scaling)</li> <li>Suitable for personal/family use (not multi-tenant)</li> </ul> <p>Future considerations:</p> <ul> <li>PostgreSQL support for multi-user scenarios</li> <li>Distributed caching for multiple instances</li> <li>Read replicas for database queries</li> </ul> <h2 id=nfs-resilience-performance>NFS Resilience &amp; Performance</h2> <p>Media Viewer is designed to work reliably with NFS-mounted media directories, which can experience transient failures not seen with local filesystems.</p> <h3 id=common-nfs-issues>Common NFS Issues</h3> <dl> <dt><strong>Stale File Handle (ESTALE)</strong></dt> <dd>NFS returns this error when a file handle becomes invalid due to:</dd> </dl> <ul> <li>File deletion or modification on the server</li> <li>NFS server restart or failover</li> <li>Network interruptions</li> <li>Cache coherency issues</li> </ul> <dl> <dt><strong>High Metadata Latency</strong></dt> <dd>NFS metadata operations (stat, readdir) are slower than local filesystems due to network round trips.</dd> <dt><strong>Connection Instability</strong></dt> <dd>Network issues can cause temporary connection loss or timeouts.</dd> </dl> <h3 id=automatic-retry-mechanism>Automatic Retry Mechanism</h3> <p>The <code>internal/filesystem</code> package provides resilient wrappers for filesystem operations:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=c1>// Stat with automatic retry for ESTALE errors</span>
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=nx>info</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>filesystem</span><span class=p>.</span><span class=nx>StatWithRetry</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span><span class=w> </span><span class=nx>filesystem</span><span class=p>.</span><span class=nx>DefaultRetryConfig</span><span class=p>())</span>
<a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>
<a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=c1>// Open with automatic retry for ESTALE errors</span>
<a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=nx>file</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>filesystem</span><span class=p>.</span><span class=nx>OpenWithRetry</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span><span class=w> </span><span class=nx>filesystem</span><span class=p>.</span><span class=nx>DefaultRetryConfig</span><span class=p>())</span>
</code></pre></div> <p><strong>Retry Configuration:</strong></p> <ul> <li><strong>MaxRetries</strong>: 3 attempts (default)</li> <li><strong>InitialBackoff</strong>: 50ms</li> <li><strong>MaxBackoff</strong>: 500ms (exponential backoff: 50ms → 100ms → 200ms)</li> <li><strong>Error Detection</strong>: Only ESTALE (errno 116) triggers retries</li> </ul> <p><strong>Performance Impact:</strong></p> <ul> <li>Successful operations: ~100-150ns overhead</li> <li>Failed operations: Add backoff delay (default: 50ms + 100ms + 200ms = 350ms)</li> <li>Transparent to callers: Drop-in replacement for <code>os.Stat</code> and <code>os.Open</code></li> </ul> <h3 id=worker-tuning-for-nfs>Worker Tuning for NFS</h3> <p>The <code>INDEX_WORKERS</code> environment variable controls indexer parallelism:</p> <p><strong>Default Behavior:</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=c1># Defaults to 3 workers (NFS-safe)</span>
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=c1># No environment variable needed</span>
</code></pre></div> <p><strong>For Tuning:</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=c1># Conservative (for problematic NFS)</span>
<a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=nv>INDEX_WORKERS</span><span class=o>=</span><span class=m>1</span>
<a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a>
<a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=c1># Aggressive (for fast NFS or local storage)</span>
<a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=nv>INDEX_WORKERS</span><span class=o>=</span><span class=m>16</span>
</code></pre></div> <p><strong>Why It Matters:</strong></p> <ul> <li>Too many workers → NFS server overwhelmed → ESTALE errors</li> <li>Too few workers → Slow indexing performance</li> <li>Default (3 workers) balances stability and performance</li> </ul> <h3 id=integration-points>Integration Points</h3> <p>The retry mechanism is integrated throughout the application:</p> <table> <thead> <tr> <th>Component</th> <th>Usage</th> <th>Purpose</th> </tr> </thead> <tbody> <tr> <td><code>handlers/media.go</code></td> <td>File serving, streaming</td> <td>Prevent 404 errors on transient failures</td> </tr> <tr> <td><code>media/thumbnail.go</code></td> <td>Thumbnail generation</td> <td>Prevent generation failures on ESTALE</td> </tr> <tr> <td><code>handlers/files.go</code></td> <td>Directory listing</td> <td>Prevent empty listings on transient failures</td> </tr> <tr> <td><code>indexer/parallel.go</code></td> <td>Directory scanning</td> <td>Resilient indexing with configurable workers</td> </tr> </tbody> </table> <h3 id=monitoring-nfs-health>Monitoring NFS Health</h3> <p><strong>Retry-Specific Metrics:</strong></p> <ul> <li><code>media_viewer_filesystem_retry_attempts_total{operation="stat|open"}</code> - Count of retry attempts</li> <li><code>media_viewer_filesystem_retry_success_total{operation="stat|open"}</code> - Successful recoveries from ESTALE</li> <li><code>media_viewer_filesystem_retry_failures_total{operation="stat|open"}</code> - Failed retries after exhausting attempts</li> <li><code>media_viewer_filesystem_estale_errors_total{operation="stat|open"}</code> - Total ESTALE errors encountered</li> <li><code>media_viewer_filesystem_retry_duration_seconds{operation="stat|open"}</code> - Duration including retry delays</li> </ul> <p><strong>General Filesystem Metrics:</strong></p> <ul> <li><code>media_viewer_filesystem_operation_duration_seconds{directory,operation}</code> - Operation latency by directory</li> <li><code>media_viewer_filesystem_operation_errors_total{directory,operation}</code> - Operation error counts</li> <li><code>media_viewer_indexer_files_per_second</code> - Indexing throughput</li> </ul> <p><strong>Log Messages:</strong></p> <ul> <li>INFO: <code>"NFS Stat succeeded on retry N for &lt;path&gt;"</code> - Recoverable error</li> <li>ERROR: <code>"NFS Stat failed after N retries for &lt;path&gt;"</code> - Persistent issue requiring investigation</li> </ul> <p><strong>Example Alerts:</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=c1># Alert when retry failure rate is high</span>
<a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HighNFSRetryFailureRate</span>
<a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=w>  </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rate(media_viewer_filesystem_retry_failures_total[5m]) &gt; 0.1</span>
<a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span>
<a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=w>      </span><span class=nt>summary</span><span class=p>:</span><span class=w> </span><span class=s>&#39;High</span><span class=nv> </span><span class=s>rate</span><span class=nv> </span><span class=s>of</span><span class=nv> </span><span class=s>NFS</span><span class=nv> </span><span class=s>retry</span><span class=nv> </span><span class=s>failures&#39;</span>
<a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a>
<a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=c1># Alert when ESTALE errors are frequent</span>
<a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">FrequentNFSStaleErrors</span>
<a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=w>  </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rate(media_viewer_filesystem_estale_errors_total[5m]) &gt; 1</span>
<a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span>
<a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=w>      </span><span class=nt>summary</span><span class=p>:</span><span class=w> </span><span class=s>&#39;Frequent</span><span class=nv> </span><span class=s>ESTALE</span><span class=nv> </span><span class=s>errors</span><span class=nv> </span><span class=s>indicating</span><span class=nv> </span><span class=s>NFS</span><span class=nv> </span><span class=s>issues&#39;</span>
</code></pre></div> <h3 id=best-practices>Best Practices</h3> <ol> <li><strong>Mount Options</strong>: Use <code>hard,intr,async</code> for better performance and reliability</li> <li><strong>Worker Tuning</strong>: Start with default (3), adjust based on metrics</li> <li><strong>Monitor Logs</strong>: Watch for retry patterns indicating NFS issues</li> <li><strong>NFS Server</strong>: Ensure adequate resources (CPU, memory, network) on NFS server</li> <li><strong>Network</strong>: Use dedicated network for NFS traffic if possible</li> </ol> <p>See also: <a href=../../admin/environment-variables/#index_workers>INDEX_WORKERS Environment Variable</a> and <a href=../../troubleshooting/#nfs-stale-file-handle-errors>NFS Troubleshooting</a></p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/djryanj/media-viewer target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.79ae519e.min.js></script> </body> </html>