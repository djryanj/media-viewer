name: CI

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

concurrency:
    group: ci-${{ github.ref }}
    cancel-in-progress: true

jobs:
    changes:
        name: Detect Changes
        runs-on: home-runners
        permissions:
            pull-requests: read
        outputs:
            go: ${{ steps.filter.outputs.go }}
            docker: ${{ steps.filter.outputs.docker }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Check for changes
              uses: dorny/paths-filter@v3
              id: filter
              with:
                  filters: |
                      go:
                        - '**/*.go'
                        - 'go.mod'
                        - 'go.sum'
                      docker:
                        - 'Dockerfile'
                        - '.dockerignore'

    lint:
        name: Lint
        runs-on: home-runners
        needs: changes
        if: needs.changes.outputs.go == 'true' || github.event_name == 'push'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v6
              with:
                  go-version-file: go.mod
                  cache: true

            - name: Run golangci-lint
              uses: golangci/golangci-lint-action@v9
              with:
                  version: latest
                  args: --timeout=5m

    build-docker:
        name: Build Docker Image
        runs-on: home-runners
        needs: [changes, lint]
        if: |
            always() &&
            (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
            (needs.changes.outputs.docker == 'true' || needs.changes.outputs.go == 'true' || github.event_name == 'push')
        permissions:
            contents: read
            packages: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image (no push)
              uses: docker/build-push-action@v6
              with:
                  context: .
                  platforms: linux/amd64
                  push: false
                  cache-from: type=gha,scope=buildkit-main
                  cache-to: type=gha,mode=max,scope=buildkit-${{ github.ref_name }}

    ci-success:
        name: CI Success
        runs-on: home-runners
        needs: [lint, build-docker]
        if: always()
        steps:
            - name: Check all jobs passed
              run: |
                  if [[ "${{ needs.lint.result }}" == "failure" ]] || \
                     [[ "${{ needs.build-docker.result }}" == "failure" ]]; then
                    echo "One or more jobs failed"
                    exit 1
                  fi
                  echo "All CI checks passed"
