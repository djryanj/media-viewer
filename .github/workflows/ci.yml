name: CI

on:
    push:
        branches:
            - '**' # Run on all branches
    pull_request:
        branches:
            - main

concurrency:
    group: ci-${{ github.ref }}
    cancel-in-progress: true

jobs:
    changes:
        name: Detect Changes
        runs-on: ubuntu-latest
        permissions:
            pull-requests: read
        outputs:
            go: ${{ steps.filter.outputs.go }}
            static-only: ${{ steps.filter.outputs.static-only }}
            docker: ${{ steps.filter.outputs.docker }}
            docker-related: ${{ steps.filter.outputs.docker-related }}
            go-packages: ${{ steps.detect-packages.outputs.packages }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Check for changes
              uses: dorny/paths-filter@v3
              id: filter
              with:
                  filters: |
                      go:
                        - '**/*.go'
                        - 'go.mod'
                        - 'go.sum'
                        - 'Makefile'
                      static-only:
                        - 'static/**'
                      docker:
                        - 'Dockerfile'
                        - '.dockerignore'
                      docker-related:
                        - 'Dockerfile'
                        - '.dockerignore'
                        - '.github/workflows/*.yml'

            - name: Detect changed Go packages
              id: detect-packages
              if: steps.filter.outputs.go == 'true'
              run: |
                  # Get list of changed Go files
                  if [ "${{ github.event_name }}" = "pull_request" ]; then
                    CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.go$' || true)
                  else
                    CHANGED_FILES=$(git diff --name-only HEAD~1 | grep '\.go$' || true)
                  fi

                  # Extract unique packages from changed files
                  PACKAGES=$(echo "$CHANGED_FILES" | xargs -n1 dirname | sort -u | sed 's|^|./|' | tr '\n' ' ')

                  if [ -z "$PACKAGES" ]; then
                    PACKAGES="./..."
                  fi

                  echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
                  echo "Changed packages: $PACKAGES"

            - name: Detect changed Go packages
              id: detect-packages
              if: steps.filter.outputs.go == 'true'
              run: |
                  # Get list of changed Go files
                  if [ "${{ github.event_name }}" = "pull_request" ]; then
                    CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.go$' || true)
                  else
                    CHANGED_FILES=$(git diff --name-only HEAD~1 | grep '\.go$' || true)
                  fi

                  # Extract unique packages from changed files
                  PACKAGES=$(echo "$CHANGED_FILES" | xargs -n1 dirname | sort -u | sed 's|^|./|' | tr '\n' ' ')

                  if [ -z "$PACKAGES" ]; then
                    PACKAGES="./..."
                  fi

                  echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
                  echo "Changed packages: $PACKAGES"

    lint:
        name: Lint
        runs-on: ubuntu-latest
        needs: changes
        # Skip if only static files changed
        if: |
            needs.changes.outputs.go == 'true' &&
            needs.changes.outputs.static-only == 'false'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Install libvips
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libvips-dev

            - name: Set up Go
              uses: actions/setup-go@v6
              with:
                  go-version-file: go.mod
                  cache: true

            - name: Run golangci-lint
              uses: golangci/golangci-lint-action@v9
              with:
                  version: latest
                  args: --timeout=5m

    build:
        name: Build Check
        runs-on: ubuntu-latest
        needs: changes
        # Skip if only static files changed
        if: |
            needs.changes.outputs.go == 'true' &&
            needs.changes.outputs.static-only == 'false'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Install libvips
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libvips-dev

            - name: Set up Go
              uses: actions/setup-go@v6
              with:
                  go-version-file: go.mod
                  cache: true

            - name: Build application
              run: |
                  make build

            - name: Build password reset tool
              run: |
                  make resetpw

    test-unit:
        name: Unit Tests
        runs-on: ubuntu-latest
        needs: changes
        # Skip if only static files changed
        if: |
            needs.changes.outputs.go == 'true' &&
            needs.changes.outputs.static-only == 'false'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Install libvips
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libvips-dev

            - name: Set up Go
              uses: actions/setup-go@v6
              with:
                  go-version-file: go.mod
                  cache: true

            - name: Run unit tests
              run: |
                  # Run tests excluding integration tests
                  make test-unit

            - name: Upload test results
              if: always()
              uses: actions/upload-artifact@v6
              with:
                  name: unit-test-results
                  path: |
                      coverage-unit.out
                      test-unit.json

    test-integration:
        name: Integration Tests
        runs-on: ubuntu-latest
        needs: changes
        # Only run on PRs (not on regular branch pushes)
        if: |
            github.event_name == 'pull_request' &&
            needs.changes.outputs.go == 'true' &&
            needs.changes.outputs.static-only == 'false'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libvips-dev ffmpeg

            - name: Set up Go
              uses: actions/setup-go@v6
              with:
                  go-version-file: go.mod
                  cache: true

            - name: Run integration tests
              run: |
                  make test-integration

            - name: Upload coverage
              if: always()
              uses: actions/upload-artifact@v6
              with:
                  name: integration-test-results
                  path: |
                      coverage-integration.out
                      test-integration.json

    test-race:
        name: Race Detector
        runs-on: ubuntu-latest
        needs: changes
        # Only run when explicitly requested via label (not ready for general use)
        if: |
            github.event_name == 'pull_request' &&
            contains(github.event.pull_request.labels.*.name, 'test:race') &&
            needs.changes.outputs.go == 'true'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Install libvips and ffmpeg
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libvips-dev ffmpeg

            - name: Set up Go
              uses: actions/setup-go@v6
              with:
                  go-version-file: go.mod
                  cache: true

            - name: Run tests with race detector
              run: |
                  make test-race

    build-docker:
        name: Build Docker Image
        runs-on: ubuntu-latest
        needs: [changes, lint, test-unit, build]
        # On branch pushes: only if Dockerfile or GHA files changed
        # On PRs: always build and push (after tests pass)
        if: |
            always() &&
            (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
            (needs.test-unit.result == 'success' || needs.test-unit.result == 'skipped') &&
            (needs.build.result == 'success' || needs.build.result == 'skipped') &&
            (
              (github.event_name == 'push' && needs.changes.outputs.docker-related == 'true') ||
              (github.event_name == 'pull_request')
            )
        permissions:
            contents: read
            packages: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Container Registry
              if: github.event_name == 'pull_request'
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata for Docker
              if: github.event_name == 'pull_request'
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ghcr.io/${{ github.repository }}
                  tags: |
                      type=ref,event=pr

            - name: Build and push Docker image (PR)
              if: github.event_name == 'pull_request'
              uses: docker/build-push-action@v6
              with:
                  context: .
                  platforms: linux/amd64
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha,scope=buildkit-main
                  cache-to: type=gha,mode=max,scope=buildkit-${{ github.ref_name }}

            - name: Build Docker image (branch push, no push)
              if: github.event_name == 'push'
              uses: docker/build-push-action@v6
              with:
                  context: .
                  platforms: linux/amd64
                  push: false
                  cache-from: type=gha,scope=buildkit-main
                  cache-to: type=gha,mode=max,scope=buildkit-${{ github.ref_name }}

            - name: Comment PR with image info
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const prNumber = context.issue.number;
                      const imageTag = `ghcr.io/${{ github.repository }}:pr-${prNumber}`;
                      const comment = `## Docker Image Built

                      A Docker image has been built and pushed for this PR:

                      \`\`\`bash
                      docker pull ${imageTag}
                      \`\`\`

                      You can use this image to test changes in your infrastructure before merging.

                      **Note:** This image is AMD64 only. Multi-arch images are built on release.`;

                      github.rest.issues.createComment({
                          issue_number: prNumber,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          body: comment
                      });

    ci-success:
        name: CI Success
        runs-on: ubuntu-latest
        needs: [lint, build, test-unit, test-integration, test-race, build-docker]
        if: always()
        steps:
            - name: Check required jobs passed
              run: |
                  # Check lint (required if ran)
                  if [[ "${{ needs.lint.result }}" == "failure" ]]; then
                    echo "❌ Lint failed"
                    exit 1
                  fi

                  # Check build (required if ran)
                  if [[ "${{ needs.build.result }}" == "failure" ]]; then
                    echo "❌ Build failed"
                    exit 1
                  fi

                  # Check unit tests (required if ran)
                  if [[ "${{ needs.test-unit.result }}" == "failure" ]]; then
                    echo "❌ Unit tests failed"
                    exit 1
                  fi

                  # Check integration tests (required on PRs if ran)
                  if [[ "${{ needs.test-integration.result }}" == "failure" ]]; then
                    echo "❌ Integration tests failed"
                    exit 1
                  fi

                  # Check race detector (optional, only fails if it ran and failed)
                  if [[ "${{ needs.test-race.result }}" == "failure" ]]; then
                    echo "❌ Race detector found issues"
                    exit 1
                  fi

                  # Check docker build (required if ran)
                  if [[ "${{ needs.build-docker.result }}" == "failure" ]]; then
                    echo "❌ Docker build failed"
                    exit 1
                  fi

                  # Determine context
                  if [[ "${{ github.event_name }}" == "pull_request" ]]; then
                    echo "✅ All PR checks passed!"
                  else
                    echo "✅ All branch push checks passed!"
                  fi
