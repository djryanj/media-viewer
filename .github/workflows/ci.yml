name: CI

on:
    push:
        branches:
            - '**' # Run on all branches
    pull_request:
        branches:
            - main

concurrency:
    group: ci-${{ github.ref }}
    cancel-in-progress: true

jobs:
    changes:
        name: Detect Changes
        runs-on: home-runners
        permissions:
            pull-requests: read
        outputs:
            go: ${{ steps.filter.outputs.go }}
            frontend: ${{ steps.filter.outputs.frontend }}
            static-only: ${{ steps.filter.outputs.static-only }}
            docker: ${{ steps.filter.outputs.docker }}
            docker-related: ${{ steps.filter.outputs.docker-related }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Check for changes
              uses: dorny/paths-filter@v3
              id: filter
              with:
                  filters: |
                      go:
                        - '**/*.go'
                        - 'go.mod'
                        - 'go.sum'
                        - 'Makefile'
                      frontend:
                        - 'static/**/*.js'
                        - 'static/**/*.css'
                        - 'static/**/*.html'
                        - 'static/package.json'
                        - 'static/package-lock.json'
                        - 'static/vitest.config.js'
                        - 'static/playwright.config.js'
                        - 'static/eslint.config.js'
                      static-only:
                        - 'static/**'
                      docker:
                        - 'Dockerfile'
                        - 'Dockerfile.nvidia'
                        - '.dockerignore'
                      docker-related:
                        - 'Dockerfile'
                        - 'Dockerfile.nvidia'
                        - '.dockerignore'
                        - '.github/workflows/*.yml'

    lint:
        name: Lint
        runs-on: home-runners
        needs: changes
        # Skip if only static files changed (no Go changes)
        if: needs.changes.outputs.go == 'true'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Install libvips
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libvips-dev

            - name: Set up Go
              uses: actions/setup-go@v6
              with:
                  go-version-file: go.mod
                  cache: true

            - name: Run golangci-lint
              uses: golangci/golangci-lint-action@v9
              with:
                  version: latest
                  args: --config=.golangci.yml --timeout=5m

    build:
        name: Build Check
        runs-on: home-runners
        needs: changes
        # Skip if only static files changed (no Go changes)
        if: needs.changes.outputs.go == 'true'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Install libvips
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libvips-dev

            - name: Set up Go
              uses: actions/setup-go@v6
              with:
                  go-version-file: go.mod
                  cache: true

            - name: Build application
              run: |
                  make build

            - name: Build password reset tool
              run: |
                  make resetpw

    test-unit:
        name: Unit Tests
        runs-on: home-runners
        needs: changes
        # Skip if only static files changed (no Go changes)
        if: needs.changes.outputs.go == 'true'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Install libvips
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libvips-dev

            - name: Set up Go
              uses: actions/setup-go@v6
              with:
                  go-version-file: go.mod
                  cache: true

            - name: Run unit tests
              run: |
                  # Run tests excluding integration tests
                  make test-unit

            - name: Generate coverage report
              if: always()
              run: |
                  echo "## Unit Test Coverage" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                  go tool cover -func=coverage-unit.out | tail -20 >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

            # - name: Comment PR with coverage
            #   if: github.event_name == 'pull_request'
            #   uses: actions/github-script@v7
            #   with:
            #       script: |
            #           const fs = require('fs');
            #           const { execSync } = require('child_process');

            #           // Get coverage summary
            #           const coverage = execSync('go tool cover -func=coverage-unit.out').toString();
            #           const lines = coverage.split('\n');
            #           const totalLine = lines[lines.length - 2] || lines[lines.length - 1];
            #           const totalMatch = totalLine.match(/total:.*?(\d+\.\d+)%/);
            #           const totalCoverage = totalMatch ? totalMatch[1] : 'N/A';

            #           // Get top 10 and bottom 10 files by coverage
            #           const fileLines = lines.slice(0, -1).filter(line => line.includes('%'));
            #           const files = fileLines.map(line => {
            #               const match = line.match(/(.*?)\s+(\d+\.\d+)%/);
            #               return match ? { file: match[1].trim(), coverage: parseFloat(match[2]) } : null;
            #           }).filter(Boolean);

            #           files.sort((a, b) => a.coverage - b.coverage);
            #           const lowest = files.slice(0, 10);
            #           const highest = files.slice(-10).reverse();

            #           const comment = `## üìä Unit Test Coverage Report

            #           **Total Coverage: ${totalCoverage}%**

            #           <details>
            #           <summary>üî¥ Lowest Coverage (Top 10)</summary>

            #           | File | Coverage |
            #           |------|----------|
            #           ${lowest.map(f => `| \`${f.file.split('/').pop()}\` | ${f.coverage}% |`).join('\n')}
            #           </details>

            #           <details>
            #           <summary>üü¢ Highest Coverage (Top 10)</summary>

            #           | File | Coverage |
            #           |------|----------|
            #           ${highest.map(f => `| \`${f.file.split('/').pop()}\` | ${f.coverage}% |`).join('\n')}
            #           </details>

            #           <details>
            #           <summary>üìÑ Full Coverage Report</summary>

            #           \`\`\`
            #           ${coverage}
            #           \`\`\`
            #           </details>`;

            #           // Find existing coverage comment
            #           const { data: comments } = await github.rest.issues.listComments({
            #               owner: context.repo.owner,
            #               repo: context.repo.repo,
            #               issue_number: context.issue.number,
            #           });

            #           const botComment = comments.find(comment =>
            #               comment.user.type === 'Bot' &&
            #               comment.body.includes('Unit Test Coverage Report')
            #           );

            #           if (botComment) {
            #               await github.rest.issues.updateComment({
            #                   owner: context.repo.owner,
            #                   repo: context.repo.repo,
            #                   comment_id: botComment.id,
            #                   body: comment
            #               });
            #           } else {
            #               await github.rest.issues.createComment({
            #                   owner: context.repo.owner,
            #                   repo: context.repo.repo,
            #                   issue_number: context.issue.number,
            #                   body: comment
            #               });
            #           }

            - name: Upload test results
              if: always()
              uses: actions/upload-artifact@v6
              with:
                  name: unit-test-results
                  path: |
                      coverage-unit.out
                      test-unit.json

    test-integration:
        name: Integration Tests
        runs-on: home-runners
        needs: changes
        # Only run on PRs (not on regular branch pushes)
        if: |
            github.event_name == 'pull_request' &&
            needs.changes.outputs.go == 'true'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libvips-dev ffmpeg

            - name: Set up Go
              uses: actions/setup-go@v6
              with:
                  go-version-file: go.mod
                  cache: true

            - name: Run integration tests
              run: |
                  make test-integration

            - name: Generate integration coverage summary
              if: always()
              run: |
                  echo "## Integration Test Coverage" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                  if [ -f coverage-integration.out ]; then
                      go tool cover -func=coverage-integration.out | tail -20 >> $GITHUB_STEP_SUMMARY
                  else
                      echo "No coverage file generated" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

            - name: Upload coverage
              if: always()
              uses: actions/upload-artifact@v6
              with:
                  name: integration-test-results
                  path: |
                      coverage-integration.out
                      test-integration.json

    test-race:
        name: Race Detector
        runs-on: home-runners
        needs: changes
        if: |
            github.event_name == 'pull_request' &&
            needs.changes.outputs.go == 'true'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Install libvips and ffmpeg
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libvips-dev ffmpeg

            - name: Set up Go
              uses: actions/setup-go@v6
              with:
                  go-version-file: go.mod
                  cache: true

            - name: Run tests with race detector
              run: |
                  make test-race

    test-frontend:
        name: Frontend Tests
        runs-on: home-runners
        needs: changes
        # Run if frontend files changed, or if both Go and frontend changed
        if: |
            needs.changes.outputs.frontend == 'true' ||
            (needs.changes.outputs.go == 'true' && needs.changes.outputs.frontend == 'true')
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libvips-dev ffmpeg

            - name: Set up Go
              uses: actions/setup-go@v6
              with:
                  go-version-file: go.mod
                  cache: true

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'
                  cache-dependency-path: static/package-lock.json

            - name: Install frontend dependencies
              working-directory: ./static
              run: npm ci

            # commenting out for now as not ready for production
            # - name: Install Playwright browsers
            #   working-directory: ./static
            #   run: npx playwright install --with-deps

            - name: Run frontend unit tests (no backend required)
              working-directory: ./static
              run: npm run test:unit:only

            - name: Build backend
              run: make build

            - name: Download sample media
              run: make download-sample-media

            - name: Start backend server
              run: |
                  # Start backend in background
                  MEDIA_DIR=/tmp/media CACHE_DIR=/tmp/cache DATABASE_DIR=/tmp/database METRICS_ENABLED=false LOG_HEALTH_CHECKS=false ./media-viewer &
                  BACKEND_PID=$!
                  echo "BACKEND_PID=$BACKEND_PID" >> $GITHUB_ENV

                  # Wait for server to be ready
                  echo "Waiting for backend to start..."
                  for i in {1..30}; do
                    if curl -f http://localhost:8080/health > /dev/null 2>&1; then
                      echo "Backend is ready!"
                      break
                    fi
                    if [ $i -eq 30 ]; then
                      echo "Backend failed to start"
                      exit 1
                    fi
                    sleep 1
                  done

            - name: Run frontend integration tests
              working-directory: ./static
              run: npm run test:integration
              env:
                  TEST_BASE_URL: http://localhost:8080

            # commenting out for now as not ready for production
            # - name: Run frontend E2E tests
            #   working-directory: ./static
            #   run: npm run test:e2e
            #   env:
            #       BASE_URL: http://localhost:8080

            - name: Stop backend server
              if: always()
              run: |
                  if [ -n "$BACKEND_PID" ]; then
                    kill $BACKEND_PID || true
                  fi

            - name: Generate frontend coverage summary
              if: always()
              run: |
                  echo "## Frontend Test Coverage" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  if [ -f static/coverage/coverage-summary.json ]; then
                    echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
                    cat static/coverage/coverage-summary.json >> $GITHUB_STEP_SUMMARY
                    echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "No coverage report generated" >> $GITHUB_STEP_SUMMARY
                  fi

            - name: Upload frontend coverage
              if: always()
              uses: actions/upload-artifact@v6
              with:
                  name: frontend-test-results
                  path: |
                      static/coverage/
                      static/e2e/playwright-report/
                      static/e2e/test-results/

            - name: Upload Playwright report
              if: always()
              uses: actions/upload-artifact@v6
              with:
                  name: playwright-report
                  path: static/e2e/playwright-report/
                  retention-days: 30

    build-docker:
        name: Build Docker Image
        needs: [changes, lint, test-unit, test-frontend, build]
        # On branch pushes: only if Dockerfile or GHA files changed
        # On PRs: always build and push (after tests pass)
        if: |
            always() &&
            (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
            (needs.test-unit.result == 'success' || needs.test-unit.result == 'skipped') &&
            (needs.test-frontend.result == 'success' || needs.test-frontend.result == 'skipped') &&
            (needs.build.result == 'success' || needs.build.result == 'skipped') &&
            (
              (github.event_name == 'push' && needs.changes.outputs.docker-related == 'true') ||
              (github.event_name == 'pull_request')
            )
        uses: ./.github/workflows/docker-build.yml
        secrets: inherit
        with:
            push: ${{ github.event_name == 'pull_request' }}
            platforms: 'linux/amd64'
            dockerfile: 'Dockerfile'
        permissions:
            contents: read
            packages: write

    build-docker-nvidia:
        name: Build Docker Image (NVIDIA)
        needs: [changes, lint, test-unit, test-frontend, build]
        # On branch pushes: only if Dockerfile or GHA files changed
        # On PRs: always build and push (after tests pass)
        if: |
            always() &&
            (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
            (needs.test-unit.result == 'success' || needs.test-unit.result == 'skipped') &&
            (needs.test-frontend.result == 'success' || needs.test-frontend.result == 'skipped') &&
            (needs.build.result == 'success' || needs.build.result == 'skipped') &&
            (
              (github.event_name == 'push' && needs.changes.outputs.docker-related == 'true') ||
              (github.event_name == 'pull_request')
            )
        uses: ./.github/workflows/docker-build.yml
        secrets: inherit
        with:
            push: ${{ github.event_name == 'pull_request' }}
            platforms: 'linux/amd64'
            dockerfile: 'Dockerfile.nvidia'
            image-suffix: '-nvidia'
        permissions:
            contents: read
            packages: write

            # - name: Comment PR with image info
            #   if: github.event_name == 'pull_request'
            #   uses: actions/github-script@v7
            #   with:
            #       script: |
            #           const prNumber = context.issue.number;
            #           const imageTag = `ghcr.io/${{ github.repository }}:pr-${prNumber}`;
            #           const comment = `## Docker Image Built

            #           A Docker image has been built and pushed for this PR:

            #           \`\`\`bash
            #           docker pull ${imageTag}
            #           \`\`\`

            #           You can use this image to test changes in your infrastructure before merging.

            #           **Note:** This image is AMD64 only. Multi-arch images are built on release.`;

            #           github.rest.issues.createComment({
            #               issue_number: prNumber,
            #               owner: context.repo.owner,
            #               repo: context.repo.repo,
            #               body: comment
            #           });

    ci-success:
        name: CI Success
        runs-on: home-runners
        needs:
            [
                lint,
                build,
                test-unit,
                test-integration,
                test-race,
                test-frontend,
                build-docker,
                build-docker-nvidia,
            ]
        if: always()
        steps:
            - name: Check required jobs passed
              run: |
                  # Check lint (required if ran)
                  if [[ "${{ needs.lint.result }}" == "failure" ]]; then
                    echo "‚ùå Lint failed"
                    exit 1
                  fi

                  # Check build (required if ran)
                  if [[ "${{ needs.build.result }}" == "failure" ]]; then
                    echo "‚ùå Build failed"
                    exit 1
                  fi

                  # Check unit tests (required if ran)
                  if [[ "${{ needs.test-unit.result }}" == "failure" ]]; then
                    echo "‚ùå Unit tests failed"
                    exit 1
                  fi

                  # Check frontend tests (required if ran)
                  if [[ "${{ needs.test-frontend.result }}" == "failure" ]]; then
                    echo "‚ùå Frontend tests failed"
                    exit 1
                  fi

                  # Check integration tests (required on PRs if ran)
                  if [[ "${{ needs.test-integration.result }}" == "failure" ]]; then
                    echo "‚ùå Integration tests failed"
                    exit 1
                  fi

                  # Check race detector (optional, only fails if it ran and failed)
                  if [[ "${{ needs.test-race.result }}" == "failure" ]]; then
                    echo "‚ùå Race detector found issues"
                    exit 1
                  fi

                  # Check docker build (required if ran)
                  if [[ "${{ needs.build-docker.result }}" == "failure" ]]; then
                    echo "‚ùå Docker build failed"
                    exit 1
                  fi

                  # Check docker nvidia build (required if ran)
                  if [[ "${{ needs.build-docker-nvidia.result }}" == "failure" ]]; then
                    echo "‚ùå Docker NVIDIA build failed"
                    exit 1
                  fi

                  # Determine context
                  if [[ "${{ github.event_name }}" == "pull_request" ]]; then
                    echo "‚úÖ All PR checks passed!"
                  else
                    echo "‚úÖ All branch push checks passed!"
                  fi
