# Transcoder Testing Guide

This document explains package-specific testing details for the transcoder package. For general testing practices, see [Testing Guide](../../docs/development/testing.md).

## Test Organization

The transcoder package follows the project's testing structure with unit and integration tests:

### Unit Tests (Fast, Mocked)

**Location:** `transcoder_test.go` and `transcoder_coverage_test.go`

**Run with:**

```bash
make test-unit
# or package-specific
make test-package PKG=transcoder
# or directly
go test -short ./internal/transcoder
```

**Characteristics:**

- Use mock ffmpeg/ffprobe scripts to avoid external dependencies
- Fast execution (milliseconds per test)
- Skip when `testing.Short()` is true
- Run in CI on every commit (part of `test-unit` job)
- Enable `t.Parallel()` for concurrent execution

**Coverage:**

- Struct initialization and configuration
- Codec/container compatibility maps
- Mock ffprobe output parsing
- File system operations (cache management)
- Error handling and edge cases

### Integration Tests (Real Dependencies)

**Location:** `transcoder_coverage_test.go` (functions with `Integration` suffix)

**Run with:**

```bash
make test-integration
# or package-specific
make test-package PKG=transcoder TESTARGS="-run=Integration"
# or directly
go test -run=Integration ./internal/transcoder
```

**Characteristics:**

- Use real ffmpeg/ffprobe binaries
- Use test video from `/testdata/test.mp4`
- Require `ffmpeg` and `ffprobe` to be installed
- Skip when `testing.Short()` is true (via `checkFFmpegAvailable`)
- Run in CI on `main` branch or with `test:integration` label
- Slower execution (seconds per test)

**Coverage:**

- Real video file parsing with ffprobe
- Actual video streaming
- Video transcoding with ffmpeg
- Resize operations
- Context cancellation with real processes
- Process management and cleanup
- Performance benchmarking

## Running Tests

See the main [Testing Guide](../../docs/development/testing.md#running-tests) for general test commands.

### Package-Specific Commands

#### Run all tests for transcoder:

```bash
make test-package PKG=transcoder
```

#### Run only unit tests (fast):

```bash
make test-unit
# or
go test -short -v ./internal/transcoder
```

#### Run only integration tests:

```bash
make test-integration
# or
go test -v -run=Integration ./internal/transcoder
```

#### Run specific test:

```bash
make test-package PKG=transcoder TESTARGS="-run=TestGetVideoInfoIntegration_RealVideo"
```

#### Run with coverage:

```bash
make test-coverage PKG=transcoder
```

#### Run benchmarks:

```bash
# Unit benchmarks only
go test -short -bench=. ./internal/transcoder

# All benchmarks (including integration)
go test -bench=. ./internal/transcoder
```

## CI/CD Integration

The transcoder package follows the project's CI workflow. See [CI documentation](../../docs/development/testing.md#continuous-integration) for complete details.

### How Tests Run in CI

**Pull Requests:**

- ✅ Unit tests run automatically (`test-unit` job)
- ⚠️ Integration tests only run with `test:integration` label
- FFmpeg is **not** installed by default

**Main Branch:**

- ✅ Unit tests run automatically
- ✅ Integration tests run automatically
- FFmpeg is installed in the `test-integration` job

### Adding the Integration Test Label

To run integration tests on your PR:

1. Add the `test:integration` label to your pull request
2. CI will install ffmpeg and run integration tests
3. Both unit and integration tests must pass

Configuration details: `.github/workflows/ci.yml`

## Test Data Files

### Test Video

The transcoder integration tests use a real test video:

- **Location:** `/testdata/test.mp4`
- **Generated by:** `/testdata/generate.sh`
- **Properties:** 1 second duration, 320x240 resolution, ~3KB file size, h264 codec
- **Purpose:** Minimal real video for testing ffmpeg/ffprobe integration

See `/testdata/README.md` for more details about test media files.

### Mock Implementations

Unit tests create temporary bash scripts that simulate ffmpeg/ffprobe behavior:

- Return predefined JSON output for testing parsing logic
- Allow testing without installing actual dependencies
- Temporary scripts are created in `t.TempDir()` and cleaned up automatically
- PATH is temporarily modified to use mocks

## Writing New Tests

See the main [Testing Guide](../../docs/development/testing.md#writing-tests) for general best practices.

### Package-Specific Guidelines

#### For Unit Tests:

1. Use table-driven test structure
2. Create mock ffprobe/ffmpeg scripts in `t.TempDir()`
3. No `Integration` suffix in function name
4. Should complete in < 100ms
5. Use `t.Parallel()` for concurrent execution
6. Add to `transcoder_test.go` or `transcoder_coverage_test.go`

Example mock setup:

```go
func TestGetVideoInfo_ParsesFFProbeOutput(t *testing.T) {
    t.Parallel()

    tmpDir := t.TempDir()
    mockFFProbe := filepath.Join(tmpDir, "ffprobe")

    ffprobeScript := `#!/bin/bash
cat << 'EOF'
{"streams":[{"codec_name":"h264","width":1920,"height":1080}],"format":{"duration":"125.5"}}
EOF
`

    if err := os.WriteFile(mockFFProbe, []byte(ffprobeScript), 0755); err != nil {
        t.Fatalf("Failed to create mock ffprobe: %v", err)
    }

    oldPath := os.Getenv("PATH")
    defer func() { _ = os.Setenv("PATH", oldPath) }()
    _ = os.Setenv("PATH", tmpDir+":"+oldPath)

    // Test code here...
}
```

#### For Integration Tests:

1. Add `Integration` suffix to function name (e.g., `TestStreamVideoIntegration_NewFeature`)
2. Call `checkFFmpegAvailable(t)` at the start (skips if not available or in short mode)
3. Use `getTestVideoPath(t)` to get the test video file path
4. Use `context.WithTimeout()` with reasonable timeout (e.g., 30 seconds)
5. Handle cleanup with `defer` or `t.Cleanup()`
6. Add to `transcoder_coverage_test.go`

Example integration test:

```go
func TestStreamVideoIntegration_WithResize(t *testing.T) {
    checkFFmpegAvailable(t)
    testVideo := getTestVideoPath(t)

    tmpDir := t.TempDir()
    trans := New(tmpDir, true)
    ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
    defer cancel()

    var buf bytes.Buffer
    err := trans.StreamVideo(ctx, testVideo, &buf, 320)
    if err != nil {
        t.Fatalf("StreamVideo() error: %v", err)
    }

    if buf.Len() == 0 {
        t.Error("Expected video data")
    }
}
```

## Coverage Status

- **Current coverage:** ~90%
- **Target:** >80% (project-wide goal)
- **Test count:** 46 tests (37 unit + 9 integration) + 5 benchmarks

View coverage report:

```bash
make test-coverage PKG=transcoder
```

## Troubleshooting

### FFmpeg Not Found in Integration Tests

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y ffmpeg

# macOS
brew install ffmpeg

# Verify installation
which ffmpeg ffprobe
ffmpeg -version
```

### Test Video Not Found

```bash
# Verify test files exist
ls -lh testdata/

# Regenerate if missing
cd testdata
./generate.sh
```

### Tests Timing Out

- Integration tests use 30-second context timeouts
- If tests timeout on slower systems, increase timeout in the test
- Check if ffmpeg is actually hanging:
    ```bash
    ffmpeg -version
    ffprobe -version
    ```

### Mock Script Failures

Common issues with unit tests using mock scripts:

1. **Permission denied:** Ensure mock scripts have execute permissions (0755)
2. **Command not found:** Verify PATH modification is working
3. **Bash not available:** Ensure `/bin/bash` exists on your system

### Flaky Tests

See main [Testing Guide](../../docs/development/testing.md#common-issues) for general troubleshooting.

For transcoder-specific issues:

- Check for race conditions in process management
- Verify cleanup in `t.Cleanup()` or `defer` statements
- Ensure temporary files/directories don't conflict

## Performance Expectations

### Unit Tests:

- Constructor/getter tests: < 1ms per test
- Mock ffprobe parsing: < 50ms per test
- File operations: < 10ms per test
- Full unit test suite: < 1 second

### Integration Tests:

- `GetVideoInfo`: 100-500ms per test
- `StreamVideo` (direct): 200-1000ms per test
- `StreamVideo` (transcode): 1-5 seconds per test
- Full integration suite: 10-30 seconds

Times vary based on system performance and video complexity.

## Related Documentation

- [Main Testing Guide](../../docs/development/testing.md) - General testing practices and workflow
- [Contributing Guide](../../CONTRIBUTING.md) - Development workflow and PR process
- [Test Data README](../../testdata/README.md) - Test media files documentation
